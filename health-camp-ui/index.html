<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Campaign Management - Premium</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f8fafc;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #667eea 0%, #10b981 100%);
            --gradient-card: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
            color: var(--dark);
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Premium Header */
        .premium-header {
            background: var(--gradient-card);
            border-radius: 20px;
            padding: 30px 40px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .premium-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .premium-header p {
            color: #6b7280;
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Premium Navigation */
        .premium-nav {
            background: var(--gradient-card);
            border-radius: 20px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            gap: 8px;
            overflow-x: auto;
        }

        .nav-item {
            flex: 1;
            min-width: 200px;
            padding: 16px 24px;
            border-radius: 14px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            color: #6b7280;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .nav-item.active {
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .nav-item.active::before {
            opacity: 1;
        }

        .nav-item:hover:not(.active) {
            background: rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }

        /* Premium Cards */
        .premium-card {
            background: var(--gradient-card);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .premium-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--gradient-card);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .stat-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow);
        }

        .stat-info h3 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .stat-info p {
            color: #6b7280;
            font-weight: 500;
            font-size: 1rem;
        }

        /* Premium Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--dark);
            border: 2px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
        }

        /* Premium Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 15px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }

        /* Premium Table */
        .table-container {
            background: var(--gradient-card);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .premium-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .premium-table th {
            background: var(--gradient-primary);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .premium-table td {
            padding: 15px 12px;
            border-bottom: 1px solid rgba(229, 231, 235, 0.5);
            transition: all 0.3s ease;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .premium-table tr:hover {
            background: rgba(99, 102, 241, 0.05);
            cursor: pointer;
        }

        /* Column widths */
        .premium-table th:nth-child(1),
        .premium-table td:nth-child(1) {
            width: 25%;
            white-space: normal;
        }

        .premium-table th:nth-child(2),
        .premium-table td:nth-child(2) {
            width: 20%;
        }

        .premium-table th:nth-child(3),
        .premium-table td:nth-child(3) {
            width: 12%;
        }

        .premium-table th:nth-child(4),
        .premium-table td:nth-child(4) {
            width: 12%;
        }

        .premium-table th:nth-child(5),
        .premium-table td:nth-child(5) {
            width: 13%;
        }

        .premium-table th:nth-child(6),
        .premium-table td:nth-child(6) {
            width: 18%;
            white-space: normal;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .status-registered {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #92400e;
        }

        .status-completed {
            background: linear-gradient(135deg, #34d399, #10b981);
            color: #065f46;
        }

        /* Patient Cards */
        .patients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .patient-card {
            background: var(--gradient-card);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .patient-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .patient-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .patient-name {
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .patient-service {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 15px;
        }

        .patient-info {
            color: #6b7280;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        /* Service tags for multi-service display */
        .service-tag {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background: var(--gradient-primary);
            color: white;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Action buttons container */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--gradient-card);
            border-radius: 24px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: scale(0.9) translateY(50px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 8px;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Confirmation Modal */
        .confirmation-modal {
            max-width: 450px;
        }

        .confirmation-content {
            text-align: center;
            padding: 20px 0;
        }

        .confirmation-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .confirmation-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 15px;
        }

        .confirmation-message {
            color: #6b7280;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .confirmation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success/Error States */
        .alert {
            padding: 20px 24px;
            border-radius: 16px;
            margin-bottom: 25px;
            font-weight: 500;
            border: 1px solid;
        }

        .alert-success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-color: #10b981;
            color: #065f46;
        }

        .alert-error {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border-color: #ef4444;
            color: #991b1b;
        }

        .alert-info {
            background: linear-gradient(135deg, #dbeafe, #93c5fd);
            border-color: #3b82f6;
            color: #1e40af;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 12px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: var(--gradient-success);
            color: white;
        }

        .connection-status.disconnected {
            background: linear-gradient(135deg, #fecaca, #ef4444);
            color: #991b1b;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark);
        }

        /* Multi-Service Checkbox Styling */
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .service-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .service-checkbox:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .service-checkbox.selected {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .service-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .service-checkbox label {
            font-weight: 500;
            cursor: pointer;
            color: var(--dark);
            flex: 1;
        }

        .services-validation {
            margin-top: 15px;
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: 500;
            border: 1px solid;
        }

        .services-validation.success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-color: #10b981;
            color: #065f46;
        }

        .services-validation.error {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border-color: #ef4444;
            color: #991b1b;
        }

        /* Hidden Class */
        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
            }

            .premium-header {
                padding: 25px;
                text-align: center;
            }

            .premium-header h1 {
                font-size: 2rem;
            }

            .premium-nav {
                flex-direction: column;
                gap: 8px;
            }

            .nav-item {
                min-width: auto;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .services-grid {
                grid-template-columns: 1fr;
            }

            .patients-grid {
                grid-template-columns: 1fr;
            }

            .modal {
                padding: 25px;
                width: 95%;
            }

            .action-buttons {
                flex-direction: column;
                gap: 4px;
            }

            .action-buttons .btn {
                width: 100%;
                justify-content: center;
                font-size: 10px;
                padding: 4px 8px;
            }

            /* Mobile table adjustments */
            .premium-table th,
            .premium-table td {
                padding: 8px 4px;
                font-size: 11px;
            }

            .premium-table th:nth-child(1),
            .premium-table td:nth-child(1) {
                width: 30%;
            }

            .premium-table th:nth-child(2),
            .premium-table td:nth-child(2) {
                width: 25%;
            }

            .premium-table th:nth-child(3),
            .premium-table td:nth-child(3) {
                width: 10%;
            }

            .premium-table th:nth-child(4),
            .premium-table td:nth-child(4) {
                width: 10%;
            }

            .premium-table th:nth-child(5),
            .premium-table td:nth-child(5) {
                width: 10%;
            }

            .premium-table th:nth-child(6),
            .premium-table td:nth-child(6) {
                width: 15%;
            }
        }

        /* Premium Search */
        .search-container {
            position: relative;
            margin-bottom: 25px;
        }

        .search-input {
            width: 100%;
            padding: 16px 20px 16px 50px;
            border: 2px solid var(--border);
            border-radius: 16px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-size: 18px;
        }

        /* Checkbox Styling */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .checkbox-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        .checkbox-item label {
            font-weight: 500;
            cursor: pointer;
            color: var(--dark);
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status disconnected">üî¥ Connecting...</div>

    <div class="main-container">
        <!-- Premium Header -->
        <div class="premium-header slide-in">
            <h1>üè• Health Campaign Management</h1>
            <p>Advanced patient registration and medical records management system with multi-service support</p>
        </div>

        <!-- Premium Navigation -->
        <div class="premium-nav slide-in">
            <button class="nav-item active" onclick="switchTab(event, 'dashboard')">
                üìä Dashboard
            </button>
            <button class="nav-item" onclick="switchTab(event, 'pending')">
                üìã Pending Tests
            </button>
            <button class="nav-item" onclick="switchTab(event, 'registration')">
                ‚ûï New Registration
            </button>
            <button class="nav-item" onclick="switchTab(event, 'reports')">
                üìà Reports
            </button>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard" class="slide-in">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-info">
                            <h3 id="totalPatients">0</h3>
                            <p>Total Patients</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-info">
                            <h3 id="pendingTests">0</h3>
                            <p>Pending Tests</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-info">
                            <h3 id="completedRecords">0</h3>
                            <p>Completed Records</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-info">
                            <h3 id="completionRate">0%</h3>
                            <p>Completion Rate</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="premium-card">
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search patients by name or phone number...">
                </div>
                
                <div class="form-grid">
                    <select class="form-select" id="serviceFilter">
                        <option value="">All Services</option>
                        <option value="General consultations">General consultations</option>
                        <option value="Eye consultation">Eye consultation</option>
                        <option value="Gynaecology">Gynaecology</option>
                        <option value="Cervical cancer screening">Cervical cancer screening</option>
                        <option value="Sexual and reproductive health">Sexual and reproductive health</option>
                        <option value="Dental consultation">Dental consultation</option>
                    </select>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="registered">Pending Tests</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
            </div>

            <!-- Patients Table -->
            <div class="premium-card">
                <div id="dashboardAlert"></div>
                <div class="table-container">
                    <table class="premium-table">
                        <thead>
                            <tr>
                                <th>Patient Information</th>
                                <th>Services</th>
                                <th>Family Group</th>
                                <th>Status</th>
                                <th>Registration Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="patientsTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pending Tests View -->
        <div id="pending" class="hidden">
            <div class="premium-card">
                <h2 style="font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; color: var(--dark);">Patients Pending Tests</h2>
                <p style="color: #6b7280; margin-bottom: 25px;">Click on any patient card to complete their medical record</p>
                
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="pendingSearchInput" placeholder="Search pending patients...">
                </div>
                
                <select class="form-select" id="pendingServiceFilter" style="max-width: 300px;">
                    <option value="">All Services</option>
                    <option value="General consultations">General consultations</option>
                    <option value="Eye consultation">Eye consultation</option>
                    <option value="Gynaecology">Gynaecology</option>
                    <option value="Cervical cancer screening">Cervical cancer screening</option>
                    <option value="Sexual and reproductive health">Sexual and reproductive health</option>
                    <option value="Dental consultation">Dental consultation</option>
                </select>
            </div>

            <div id="pendingPatientsGrid" class="patients-grid">
                <!-- Pending patient cards will be inserted here -->
            </div>
        </div>

        <!-- Registration Form -->
        <div id="registration" class="hidden">
            <div class="premium-card" style="max-width: 800px; margin: 0 auto;">
                <h2 style="font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; color: var(--dark);">Patient Registration</h2>
                <p style="color: #6b7280; margin-bottom: 30px;">Register new patients for health campaign services - Select one or more services</p>

                <div id="registrationAlert"></div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" class="form-input" id="regName" required placeholder="Enter patient's full name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Age *</label>
                        <input type="number" class="form-input" id="regAge" required placeholder="Enter age">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Sex *</label>
                        <select class="form-select" id="regSex" required>
                            <option value="">Select Sex</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Occupation</label>
                        <input type="text" class="form-input" id="regOccupation" placeholder="Enter occupation (optional)">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Telephone *</label>
                    <input type="tel" class="form-input" id="regTel" required placeholder="Enter phone number">
                </div>

                <div class="form-group">
                    <label class="form-label">Family Group *</label>
                    <select class="form-select" id="regFamilyGroup" required>
                        <option value="">Select Family Group</option>
                        <option value="ESDA">ESDA</option>
                        <option value="MASUDA">MASUDA</option>
                        <option value="AKUCDA">AKUCDA</option>
                        <option value="UBACDA">UBACDA</option>
                        <option value="OTHERS">OTHERS</option>
                    </select>
                </div>

                <!-- Multi-Service Selection -->
                <div class="form-group">
                    <label class="form-label">Services * (Select one or more)</label>
                    <div class="services-grid" id="servicesCheckboxes">
                        <div class="service-checkbox">
                            <input type="checkbox" id="serviceGeneral" value="General consultations">
                            <label for="serviceGeneral">ü©∫ General consultations</label>
                        </div>
                        <div class="service-checkbox">
                            <input type="checkbox" id="serviceEye" value="Eye consultation">
                            <label for="serviceEye">üëÅÔ∏è Eye consultation</label>
                        </div>
                        <div class="service-checkbox">
                            <input type="checkbox" id="serviceGynae" value="Gynaecology">
                            <label for="serviceGynae">üë©‚Äç‚öïÔ∏è Gynaecology</label>
                        </div>
                        <div class="service-checkbox">
                            <input type="checkbox" id="serviceCervical" value="Cervical cancer screening">
                            <label for="serviceCervical">üî¨ Cervical cancer screening</label>
                        </div>
                        <div class="service-checkbox">
                            <input type="checkbox" id="serviceReproductive" value="Sexual and reproductive health">
                            <label for="serviceReproductive">üíï Sexual and reproductive health</label>
                        </div>
                        <div class="service-checkbox">
                            <input type="checkbox" id="serviceDental" value="Dental consultation">
                            <label for="serviceDental">ü¶∑ Dental consultation</label>
                        </div>
                    </div>
                    <div id="servicesValidation" class="services-validation hidden">
                        <span id="servicesValidationText"></span>
                    </div>
                </div>

                <div style="display: flex; gap: 20px; margin-top: 30px;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="registerPatient()" id="registerBtn">
                        ‚ûï Register Patient
                    </button>
                    <button class="btn btn-secondary" onclick="clearRegistrationForm()">
                        üîÑ Clear Form
                    </button>
                </div>
            </div>
        </div>

        <!-- Reports View -->
        <div id="reports" class="hidden">
            <div class="premium-card">
                <h2 style="font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; color: var(--dark);">üìà System Reports</h2>
                <p style="color: #6b7280; margin-bottom: 30px;">Comprehensive analytics and reporting dashboard</p>
                
                <div class="form-grid">
                    <button class="btn btn-primary" onclick="generateReport('summary')">
                        üìä Summary Report
                    </button>
                    <button class="btn btn-success" onclick="generateReport('detailed')">
                        üìã Detailed Report
                    </button>
                    <button class="btn btn-secondary" onclick="exportData()">
                        üíæ Export Data
                    </button>
                </div>
            </div>

            <!-- Report Results -->
            <div id="reportResults" class="premium-card hidden">
                <div class="modal-header">
                    <h3 style="color: var(--dark); font-size: 1.5rem; font-weight: 700;">Report Results</h3>
                    <button class="modal-close" onclick="closeReport()">‚úï</button>
                </div>
                <div id="reportContent"></div>
            </div>
        </div>

        <!-- Complete Record Form -->
        <div id="completionForm" class="hidden">
            <div class="premium-card" style="max-width: 800px; margin: 0 auto;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px;">
                    <button class="btn btn-secondary" onclick="switchTab(null, 'dashboard')" style="padding: 12px 16px;">
                        ‚Üê Back
                    </button>
                    <h2 style="font-size: 1.8rem; font-weight: 700; color: var(--dark); margin: 0;">Complete Medical Record</h2>
                </div>

                <div id="selectedPatientInfo" class="premium-card" style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 2px solid #3b82f6; margin-bottom: 30px;">
                </div>

                <div id="completionAlert"></div>

                <div class="form-group">
                    <label class="form-label">Diagnosis</label>
                    <textarea class="form-textarea" id="compDiagnosis" placeholder="Enter detailed diagnosis..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Lab Tests Performed</label>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="labMalaria" value="Malaria">
                            <label for="labMalaria">ü¶† Malaria Test</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="labHIV" value="HIV">
                            <label for="labHIV">üî¨ HIV Test</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="labHBV" value="HBV">
                            <label for="labHBV">üî¨ HBV Test</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="labHCV" value="HCV">
                            <label for="labHCV">üî¨ HCV Test</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="labBloodGrouping" value="Blood grouping">
                            <label for="labBloodGrouping">ü©∏ Blood Grouping</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="labBloodGlucose" value="Blood glucose">
                            <label for="labBloodGlucose">üìä Blood Glucose</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="labSyphilis" value="Syphilis">
                            <label for="labSyphilis">üî¨ Syphilis Test</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="labUltrasound" value="Ultrasound">
                            <label for="labUltrasound">üì° Ultrasound</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="labXray" value="X-ray">
                            <label for="labXray">üì∑ X-ray</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="labECG" value="ECG">
                            <label for="labECG">üíì ECG</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="labUrinalysis" value="Urinalysis">
                            <label for="labUrinalysis">üß™ Urinalysis</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="labLipidProfile" value="Lipid Profile">
                            <label for="labLipidProfile">üìà Lipid Profile</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Treatment Plan</label>
                    <textarea class="form-textarea" id="compTreatmentPlan" placeholder="Enter detailed treatment plan and recommendations..."></textarea>
                </div>

                <div style="display: flex; gap: 20px; margin-top: 30px;">
                    <button class="btn btn-success" style="flex: 1;" onclick="completeRecord()" id="completeBtn">
                        üíæ Complete Record
                    </button>
                    <button class="btn btn-secondary" onclick="switchTab(null, 'dashboard')">
                        ‚ùå Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Patient Form -->
        <div id="editForm" class="hidden">
            <div class="premium-card" style="max-width: 800px; margin: 0 auto;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px;">
                    <button class="btn btn-secondary" onclick="switchTab(null, 'dashboard')" style="padding: 12px 16px;">
                        ‚Üê Back
                    </button>
                    <h2 style="font-size: 1.8rem; font-weight: 700; color: var(--dark); margin: 0;">Edit Patient Information</h2>
                </div>

                <div id="editAlert"></div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" class="form-input" id="editName" required placeholder="Enter patient's full name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Age *</label>
                        <input type="number" class="form-input" id="editAge" required placeholder="Enter age">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Sex *</label>
                        <select class="form-select" id="editSex" required>
                            <option value="">Select Sex</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Occupation</label>
                        <input type="text" class="form-input" id="editOccupation" placeholder="Enter occupation (optional)">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Telephone *</label>
                    <input type="tel" class="form-input" id="editTel" required placeholder="Enter phone number">
                </div>

                <div class="form-group">
                    <label class="form-label">Family Group *</label>
                    <select class="form-select" id="editFamilyGroup" required>
                        <option value="">Select Family Group</option>
                        <option value="ESDA">ESDA</option>
                        <option value="MASUDA">MASUDA</option>
                        <option value="AKUCDA">AKUCDA</option>
                        <option value="UBACDA">UBACDA</option>
                        <option value="OTHERS">OTHERS</option>
                    </select>
                </div>

                <!-- Multi-Service Selection for Edit -->
                <div class="form-group">
                    <label class="form-label">Services * (Select one or more)</label>
                    <div class="services-grid" id="editServicesCheckboxes">
                        <div class="service-checkbox">
                            <input type="checkbox" id="editServiceGeneral" value="General consultations">
                            <label for="editServiceGeneral">ü©∫ General consultations</label>
                        </div>
                        <div class="service-checkbox">
                            <input type="checkbox" id="editServiceEye" value="Eye consultation">
                            <label for="editServiceEye">üëÅÔ∏è Eye consultation</label>
                        </div>
                        <div class="service-checkbox">
                            <input type="checkbox" id="editServiceGynae" value="Gynaecology">
                            <label for="editServiceGynae">üë©‚Äç‚öïÔ∏è Gynaecology</label>
                        </div>
                        <div class="service-checkbox">
                            <input type="checkbox" id="editServiceCervical" value="Cervical cancer screening">
                            <label for="editServiceCervical">üî¨ Cervical cancer screening</label>
                        </div>
                        <div class="service-checkbox">
                            <input type="checkbox" id="editServiceReproductive" value="Sexual and reproductive health">
                            <label for="editServiceReproductive">üíï Sexual and reproductive health</label>
                        </div>
                        <div class="service-checkbox">
                            <input type="checkbox" id="editServiceDental" value="Dental consultation">
                            <label for="editServiceDental">ü¶∑ Dental consultation</label>
                        </div>
                    </div>
                    <div id="editServicesValidation" class="services-validation hidden">
                        <span id="editServicesValidationText"></span>
                    </div>
                </div>

                <div style="display: flex; gap: 20px; margin-top: 30px;">
                    <button class="btn btn-success" style="flex: 1;" onclick="updatePatient()" id="updateBtn">
                        üíæ Update Patient
                    </button>
                    <button class="btn btn-secondary" onclick="switchTab(null, 'dashboard')">
                        ‚ùå Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Details Modal -->
    <div id="patientModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 style="color: var(--dark); font-size: 1.5rem; font-weight: 700;">Patient Details</h3>
                <button class="modal-close" onclick="closePatientModal()">‚úï</button>
            </div>
            <div id="patientModalContent"></div>
            <div style="display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap;">
                <button class="btn btn-primary" id="editPatientBtn" onclick="editFromModal()" style="display: none;">
                    ‚úèÔ∏è Complete Record
                </button>
                <button class="btn btn-warning" id="editInfoBtn" onclick="editPatientInfo()" style="display: none;">
                    üìù Edit Info
                </button>
                <button class="btn btn-danger" id="deletePatientBtn" onclick="confirmDeletePatient()" style="display: none;">
                    üóëÔ∏è Delete
                </button>
                <button class="btn btn-secondary" onclick="closePatientModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal confirmation-modal">
            <div class="confirmation-content">
                <div class="confirmation-icon" id="confirmationIcon">‚ö†Ô∏è</div>
                <div class="confirmation-title" id="confirmationTitle">Confirm Action</div>
                <div class="confirmation-message" id="confirmationMessage">Are you sure you want to proceed?</div>
                <div class="confirmation-buttons">
                    <button class="btn btn-danger" id="confirmActionBtn" onclick="executeConfirmedAction()">
                        Confirm
                    </button>
                    <button class="btn btn-secondary" onclick="closeConfirmationModal()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let patients = [];
        let currentPatient = null;
        let currentTab = 'dashboard';
        let isOnline = false;
        let pendingAction = null;
        let editingPatient = null;

        // API Base URL - Updated to use deployed backend
        const API_BASE_URL = 'https://health-camp-1.onrender.com/api';

        // Available services list
        const AVAILABLE_SERVICES = [
            'General consultations',
            'Eye consultation', 
            'Gynaecology',
            'Cervical cancer screening',
            'Sexual and reproductive health',
            'Dental consultation'
        ];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            setupServiceCheckboxListeners();
            checkConnection();
            
            // Auto-refresh data every 30 seconds
            setInterval(refreshData, 30000);
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', debounce(filterPatients, 300));
            document.getElementById('serviceFilter').addEventListener('change', filterPatients);
            document.getElementById('statusFilter').addEventListener('change', filterPatients);
            document.getElementById('pendingSearchInput').addEventListener('input', debounce(filterPendingPatients, 300));
            document.getElementById('pendingServiceFilter').addEventListener('change', filterPendingPatients);
        }

        function setupServiceCheckboxListeners() {
            // Registration form service checkboxes
            const regCheckboxes = document.querySelectorAll('#servicesCheckboxes input[type="checkbox"]');
            regCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateServiceCheckboxStyle(this);
                    validateServices('registration');
                });
            });

            // Edit form service checkboxes
            const editCheckboxes = document.querySelectorAll('#editServicesCheckboxes input[type="checkbox"]');
            editCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateServiceCheckboxStyle(this);
                    validateServices('edit');
                });
            });
        }

        function updateServiceCheckboxStyle(checkbox) {
            const serviceCheckbox = checkbox.closest('.service-checkbox');
            if (checkbox.checked) {
                serviceCheckbox.classList.add('selected');
            } else {
                serviceCheckbox.classList.remove('selected');
            }
        }

        function validateServices(formType) {
            const checkboxSelector = formType === 'edit' ? '#editServicesCheckboxes' : '#servicesCheckboxes';
            const validationId = formType === 'edit' ? 'editServicesValidation' : 'servicesValidation';
            const validationTextId = formType === 'edit' ? 'editServicesValidationText' : 'servicesValidationText';
            
            const selectedServices = getSelectedServices(checkboxSelector);
            const validationDiv = document.getElementById(validationId);
            const validationText = document.getElementById(validationTextId);
            
            if (selectedServices.length === 0) {
                validationDiv.className = 'services-validation error';
                validationText.innerHTML = '‚ö†Ô∏è Please select at least one service';
                return false;
            } else {
                validationDiv.className = 'services-validation success';
                validationText.innerHTML = `‚úÖ ${selectedServices.length} service${selectedServices.length > 1 ? 's' : ''} selected: ${selectedServices.join(', ')}`;
                return true;
            }
        }

        function getSelectedServices(containerSelector) {
            const checkboxes = document.querySelectorAll(`${containerSelector} input[type="checkbox"]:checked`);
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }

        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Connection check
        async function checkConnection() {
            try {
                console.log('üîç Checking connection...');
                const response = await fetch(`${API_BASE_URL}/health`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Health check response:', data);
                    updateConnectionStatus(true);
                    loadAllPatients();
                } else {
                    console.error('‚ùå Health check failed');
                    updateConnectionStatus(false);
                }
            } catch (error) {
                console.error('üí• Connection error:', error);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            isOnline = connected;
            
            if (connected) {
                statusEl.textContent = 'üü¢ Connected';
                statusEl.className = 'connection-status connected';
                clearAlert('dashboardAlert');
            } else {
                statusEl.textContent = 'üî¥ Disconnected';
                statusEl.className = 'connection-status disconnected';
                showAlert('dashboardAlert', '‚ö†Ô∏è Connection lost. Please check your internet connection.', 'error');
            }
        }

        // API functions using multi-service endpoints
        async function apiRequest(endpoint, options = {}) {
            try {
                const url = `${API_BASE_URL}${endpoint}`;
                console.log('üì° API request:', url, options);
                
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('text/html')) {
                    throw new Error('Server returned HTML instead of JSON. Check if server is running correctly.');
                }

                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || errorMessage;
                    } catch (parseError) {
                        console.error('Could not parse error response:', parseError);
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('‚úÖ API response:', data);
                return data;
            } catch (error) {
                console.error('üí• API request failed:', error);
                updateConnectionStatus(false);
                throw error;
            }
        }

        async function loadAllPatients() {
            try {
                console.log('üìã Loading all patients...');
                const data = await apiRequest('/patients');
                patients = Array.isArray(data) ? data : (data.data || []);
                updateAllViews();
                updateConnectionStatus(true);
                console.log(`‚úÖ Loaded ${patients.length} patients`);
            } catch (error) {
                console.error('‚ùå Failed to load patients:', error);
                showAlert('dashboardAlert', '‚ùå Failed to load patient data: ' + error.message, 'error');
                patients = [];
                updateAllViews();
            }
        }

        async function refreshData() {
            if (isOnline) {
                try {
                    await loadAllPatients();
                } catch (error) {
                    console.error('üîÑ Auto-refresh failed:', error);
                }
            }
        }

        // Enhanced tab switching with animations
        function switchTab(event, tabName) {
            // Update active tab
            document.querySelectorAll('.nav-item').forEach(tab => {
                tab.classList.remove('active');
            });
            if (event) {
                event.target.classList.add('active');
            }

            // Hide all views
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('pending').classList.add('hidden');
            document.getElementById('registration').classList.add('hidden');
            document.getElementById('reports').classList.add('hidden');
            document.getElementById('completionForm').classList.add('hidden');
            document.getElementById('editForm').classList.add('hidden');

            // Show selected view with animation
            const targetView = document.getElementById(tabName);
            targetView.classList.remove('hidden');
            targetView.classList.add('slide-in');
            
            currentTab = tabName;

            // Update views based on current tab
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'pending') {
                updatePendingView();
            } else if (tabName === 'registration') {
                clearRegistrationForm();
            }
        }

        // Enhanced registration function with multi-service support
        async function registerPatient() {
            const name = document.getElementById('regName').value.trim();
            const age = document.getElementById('regAge').value.trim();
            const sex = document.getElementById('regSex').value;
            const occupation = document.getElementById('regOccupation').value.trim();
            const tel = document.getElementById('regTel').value.trim();
            const familyGroup = document.getElementById('regFamilyGroup').value;
            const selectedServices = getSelectedServices('#servicesCheckboxes');

            // Enhanced validation
            if (!name || !age || !sex || !tel || !familyGroup) {
                showAlert('registrationAlert', '‚ö†Ô∏è Please fill in all required fields', 'error');
                return;
            }

            if (selectedServices.length === 0) {
                showAlert('registrationAlert', '‚ö†Ô∏è Please select at least one service', 'error');
                validateServices('registration');
                return;
            }

            // Validate phone number format
            if (tel.length < 8) {
                showAlert('registrationAlert', '‚ö†Ô∏è Please enter a valid phone number', 'error');
                return;
            }

            const registerBtn = document.getElementById('registerBtn');
            registerBtn.disabled = true;
            registerBtn.innerHTML = '<span class="loading"></span>Registering...';

            try {
                const newPatient = {
                    name,
                    age: parseInt(age),
                    sex,
                    occupation,
                    tel,
                    familyGroup,
                    services: selectedServices,
                    service: selectedServices[0] // Include first service for backward compatibility
                };

                const response = await apiRequest('/patients', {
                    method: 'POST',
                    body: JSON.stringify(newPatient)
                });

                showAlert('registrationAlert', `üéâ Patient registered successfully for ${selectedServices.length} service${selectedServices.length > 1 ? 's' : ''}! They are now pending tests.`, 'success');
                clearRegistrationForm();
                await loadAllPatients();
                
                // Show success animation
                registerBtn.innerHTML = '‚úÖ Registered!';
                setTimeout(() => {
                    registerBtn.innerHTML = '‚ûï Register Patient';
                }, 2000);
            } catch (error) {
                showAlert('registrationAlert', '‚ùå Registration failed: ' + error.message, 'error');
            } finally {
                registerBtn.disabled = false;
            }
        }

        // Enhanced update patient function with multi-service support
        async function updatePatient() {
            if (!editingPatient) return;

            const name = document.getElementById('editName').value.trim();
            const age = document.getElementById('editAge').value.trim();
            const sex = document.getElementById('editSex').value;
            const occupation = document.getElementById('editOccupation').value.trim();
            const tel = document.getElementById('editTel').value.trim();
            const familyGroup = document.getElementById('editFamilyGroup').value;
            const selectedServices = getSelectedServices('#editServicesCheckboxes');

            // Enhanced validation
            if (!name || !age || !sex || !tel || !familyGroup) {
                showAlert('editAlert', '‚ö†Ô∏è Please fill in all required fields', 'error');
                return;
            }

            if (selectedServices.length === 0) {
                showAlert('editAlert', '‚ö†Ô∏è Please select at least one service', 'error');
                validateServices('edit');
                return;
            }

            // Validate phone number format
            if (tel.length < 8) {
                showAlert('editAlert', '‚ö†Ô∏è Please enter a valid phone number', 'error');
                return;
            }

            const updateBtn = document.getElementById('updateBtn');
            updateBtn.disabled = true;
            updateBtn.innerHTML = '<span class="loading"></span>Updating...';

            try {
                const updateData = {
                    id: editingPatient._id,
                    name,
                    age: parseInt(age),
                    sex,
                    occupation,
                    tel,
                    familyGroup,
                    services: selectedServices,
                    service: selectedServices[0] // Include first service for backward compatibility
                };

                await apiRequest('/patients', {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });

                showAlert('editAlert', `üéâ Patient information updated successfully with ${selectedServices.length} service${selectedServices.length > 1 ? 's' : ''}!`, 'success');
                
                // Show success animation
                updateBtn.innerHTML = '‚úÖ Updated!';
                
                setTimeout(async () => {
                    await loadAllPatients();
                    switchTab(null, 'dashboard');
                    showAlert('dashboardAlert', `‚úÖ ${name}'s information has been updated successfully!`, 'success');
                }, 1500);
            } catch (error) {
                showAlert('editAlert', '‚ùå Update failed: ' + error.message, 'error');
                updateBtn.innerHTML = 'üíæ Update Patient';
            } finally {
                updateBtn.disabled = false;
            }
        }

        // Delete patient function
        async function deletePatient(patientId) {
            try {
                await apiRequest('/delete', {
                    method: 'POST',
                    body: JSON.stringify({ id: patientId })
                });

                await loadAllPatients();
                showAlert('dashboardAlert', '‚úÖ Patient deleted successfully!', 'success');
            } catch (error) {
                showAlert('dashboardAlert', '‚ùå Delete failed: ' + error.message, 'error');
                throw error;
            }
        }

        // Enhanced complete record function
        async function completeRecord() {
            if (!currentPatient) return;

            const diagnosis = document.getElementById('compDiagnosis').value.trim();
            const treatmentPlan = document.getElementById('compTreatmentPlan').value.trim();
            
            // Get selected lab tests
            const labTests = [];
            const checkboxes = document.querySelectorAll('#completionForm input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                labTests.push(checkbox.value);
            });

            // Basic validation
            if (!diagnosis && !treatmentPlan && labTests.length === 0) {
                showAlert('completionAlert', '‚ö†Ô∏è Please enter at least diagnosis, treatment plan, or select lab tests', 'error');
                return;
            }

            const completeBtn = document.getElementById('completeBtn');
            completeBtn.disabled = true;
            completeBtn.innerHTML = '<span class="loading"></span>Completing...';

            try {
                const updateData = {
                    id: currentPatient._id,
                    diagnosis,
                    labTests,
                    treatmentPlan,
                    status: 'completed'
                };

                await apiRequest('/patients', {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });

                showAlert('completionAlert', 'üéâ Patient record completed successfully!', 'success');
                
                // Show success animation
                completeBtn.innerHTML = '‚úÖ Completed!';
                
                setTimeout(async () => {
                    await loadAllPatients();
                    switchTab(null, 'dashboard');
                    showAlert('dashboardAlert', `‚úÖ ${currentPatient.name}'s record has been completed successfully!`, 'success');
                }, 1500);
            } catch (error) {
                showAlert('completionAlert', '‚ùå Failed to complete record: ' + error.message, 'error');
                completeBtn.innerHTML = 'üíæ Complete Record';
            } finally {
                completeBtn.disabled = false;
            }
        }

        function showCompletionForm(patient) {
            currentPatient = patient;
            
            // Hide all views
            document.querySelectorAll('#dashboard, #pending, #registration, #reports, #editForm').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById('completionForm').classList.remove('hidden');
            document.getElementById('completionForm').classList.add('slide-in');
            
            // Show patient info with enhanced styling including services
            const servicesDisplay = patient.services && patient.services.length > 0 
                ? patient.services.join(', ') 
                : (patient.service || 'Not specified');
                
            document.getElementById('selectedPatientInfo').innerHTML = `
                <h3 style="color: #1e40af; font-size: 1.4rem; font-weight: 700; margin-bottom: 15px;">
                    üë§ ${patient.name}
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; color: #1d4ed8; font-weight: 500;">
                    <div>üè• Services: ${servicesDisplay}</div>
                    <div>üìÖ Registered: ${patient.registrationDate}</div>
                    <div>üìû Phone: ${patient.tel}</div>
                    <div>üë• Family: ${patient.familyGroup}</div>
                </div>
            `;
            
            // Clear form
            clearCompletionForm();
        }

        // Enhanced show edit form with multi-service support
        function showEditForm(patient) {
            editingPatient = patient;
            
            // Hide all views
            document.querySelectorAll('#dashboard, #pending, #registration, #reports, #completionForm').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById('editForm').classList.remove('hidden');
            document.getElementById('editForm').classList.add('slide-in');
            
            // Populate form with current patient data
            document.getElementById('editName').value = patient.name;
            document.getElementById('editAge').value = patient.age;
            document.getElementById('editSex').value = patient.sex;
            document.getElementById('editOccupation').value = patient.occupation || '';
            document.getElementById('editTel').value = patient.tel;
            document.getElementById('editFamilyGroup').value = patient.familyGroup;
            
            // Handle services - support both single service and multiple services
            const patientServices = patient.services && patient.services.length > 0 
                ? patient.services 
                : (patient.service ? [patient.service] : []);
            
            // Clear all checkboxes first
            document.querySelectorAll('#editServicesCheckboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
                updateServiceCheckboxStyle(checkbox);
            });
            
            // Set selected services
            patientServices.forEach(service => {
                const checkbox = document.querySelector(`#editServicesCheckboxes input[value="${service}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    updateServiceCheckboxStyle(checkbox);
                }
            });
            
            validateServices('edit');
            clearAlert('editAlert');
        }

        // Enhanced patient details modal with multi-service support
        function showPatientDetails(patient) {
            currentPatient = patient;
            
            // Handle services display
            const servicesDisplay = patient.services && patient.services.length > 0 
                ? patient.services 
                : (patient.service ? [patient.service] : []);
            
            let modalContent = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
                    <div style="padding: 20px; background: rgba(99, 102, 241, 0.1); border-radius: 12px; border-left: 4px solid var(--primary);">
                        <h4 style="color: var(--primary); font-weight: 600; margin-bottom: 10px;">Personal Information</h4>
                        <div style="color: var(--dark); line-height: 1.8;">
                            <div><strong>Name:</strong> ${patient.name}</div>
                            <div><strong>Age:</strong> ${patient.age} years</div>
                            <div><strong>Sex:</strong> ${patient.sex}</div>
                            <div><strong>Occupation:</strong> ${patient.occupation || 'Not specified'}</div>
                        </div>
                    </div>
                    
                    <div style="padding: 20px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border-left: 4px solid var(--success);">
                        <h4 style="color: var(--success); font-weight: 600; margin-bottom: 10px;">Contact & Services</h4>
                        <div style="color: var(--dark); line-height: 1.8;">
                            <div><strong>Phone:</strong> ${patient.tel}</div>
                            <div><strong>Family Group:</strong> ${patient.familyGroup}</div>
                            <div><strong>Services:</strong></div>
                            <div style="margin-top: 8px;">
                                ${servicesDisplay.length > 0 ? 
                                    servicesDisplay.map(service => `<span class="service-tag">${service}</span>`).join('') : 
                                    '<span style="color: #6b7280;">No services specified</span>'
                                }
                            </div>
                            <div style="margin-top: 8px;"><strong>Status:</strong> <span class="status-badge ${patient.status === 'completed' ? 'status-completed' : 'status-registered'}">${patient.status === 'completed' ? 'Completed' : 'Pending'}</span></div>
                        </div>
                    </div>
                </div>

                <div style="padding: 20px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; border-left: 4px solid var(--info); margin-bottom: 20px;">
                    <h4 style="color: var(--info); font-weight: 600; margin-bottom: 10px;">üìÖ Registration Details</h4>
                    <div style="color: var(--dark);">
                        <strong>Date:</strong> ${patient.registrationDate} ${patient.registrationTime || ''}
                    </div>
                </div>
            `;

            if (patient.status === 'completed') {
                modalContent += `
                    <div style="padding: 20px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border-left: 4px solid var(--success);">
                        <h4 style="color: var(--success); font-weight: 600; margin-bottom: 15px;">üè• Medical Information</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <strong style="color: var(--dark);">Diagnosis:</strong>
                            <div style="background: white; padding: 10px; border-radius: 8px; margin-top: 5px;">
                                ${patient.diagnosis || 'Not specified'}
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: var(--dark);">Lab Tests Performed:</strong>
                            <div style="background: white; padding: 10px; border-radius: 8px; margin-top: 5px;">
                                ${patient.labTests && patient.labTests.length > 0 ? 
                                    patient.labTests.map(test => `<span class="service-tag">${test}</span>`).join('') : 
                                    'No lab tests recorded'
                                }
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: var(--dark);">Treatment Plan:</strong>
                            <div style="background: white; padding: 10px; border-radius: 8px; margin-top: 5px;">
                                ${patient.treatmentPlan || 'Not specified'}
                            </div>
                        </div>

                        <div>
                            <strong style="color: var(--dark);">Completion Date:</strong>
                            <div style="background: white; padding: 10px; border-radius: 8px; margin-top: 5px;">
                                ${patient.completionDate} ${patient.completionTime || ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // Show edit info and delete buttons for completed patients
                document.getElementById('editInfoBtn').style.display = 'inline-flex';
                document.getElementById('deletePatientBtn').style.display = 'inline-flex';
            } else {
                // Show complete record, edit info, and delete buttons for pending patients
                document.getElementById('editPatientBtn').style.display = 'inline-flex';
                document.getElementById('editInfoBtn').style.display = 'inline-flex';
                document.getElementById('deletePatientBtn').style.display = 'inline-flex';
            }

            document.getElementById('patientModalContent').innerHTML = modalContent;
            document.getElementById('patientModal').classList.add('active');
        }

        function closePatientModal() {
            document.getElementById('patientModal').classList.remove('active');
            document.getElementById('editPatientBtn').style.display = 'none';
            document.getElementById('editInfoBtn').style.display = 'none';
            document.getElementById('deletePatientBtn').style.display = 'none';
            currentPatient = null;
        }

        function editFromModal() {
            closePatientModal();
            showCompletionForm(currentPatient);
        }

        function editPatientInfo() {
            closePatientModal();
            showEditForm(currentPatient);
        }

        // Confirmation modal functions
        function showConfirmationModal(title, message, icon, action) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            document.getElementById('confirmationIcon').textContent = icon;
            pendingAction = action;
            document.getElementById('confirmationModal').classList.add('active');
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').classList.remove('active');
            pendingAction = null;
        }

        function confirmDeletePatient() {
            if (!currentPatient) return;
            
            showConfirmationModal(
                'Delete Patient',
                `Are you sure you want to delete ${currentPatient.name}? This action cannot be undone and will permanently remove all patient data including medical records.`,
                'üóëÔ∏è',
                async () => {
                    try {
                        await deletePatient(currentPatient._id);
                        closePatientModal();
                        closeConfirmationModal();
                    } catch (error) {
                        // Error already handled in deletePatient function
                    }
                }
            );
        }

        async function executeConfirmedAction() {
            if (pendingAction) {
                const confirmBtn = document.getElementById('confirmActionBtn');
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<span class="loading"></span>Processing...';
                
                try {
                    await pendingAction();
                } catch (error) {
                    console.error('Confirmed action failed:', error);
                } finally {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = 'Confirm';
                }
            }
        }

        // Update functions
        function updateAllViews() {
            updateDashboard();
            updatePendingView();
        }

        function updateDashboard() {
            try {
                // Update statistics
                const totalPatients = patients.length;
                const pendingTests = patients.filter(p => p.status === 'registered').length;
                const completedRecords = patients.filter(p => p.status === 'completed').length;
                const completionRate = totalPatients > 0 ? Math.round((completedRecords / totalPatients) * 100) : 0;

                // Animate numbers
                animateNumber('totalPatients', totalPatients);
                animateNumber('pendingTests', pendingTests);
                animateNumber('completedRecords', completedRecords);
                animateNumber('completionRate', completionRate, '%');

                // Update table
                filterPatients();
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }

        function animateNumber(elementId, targetNumber, suffix = '') {
            const element = document.getElementById(elementId);
            const currentNumber = parseInt(element.textContent) || 0;
            const increment = targetNumber > currentNumber ? 1 : -1;
            const timer = setInterval(() => {
                const current = parseInt(element.textContent) || 0;
                if (current === targetNumber) {
                    clearInterval(timer);
                } else {
                    element.textContent = (current + increment) + suffix;
                }
            }, 50);
        }

        function updatePendingView() {
            filterPendingPatients();
        }

        function filterPatients() {
            try {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const serviceFilter = document.getElementById('serviceFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;

                let filteredPatients = [...patients];

                // Apply filters
                if (searchTerm) {
                    filteredPatients = filteredPatients.filter(patient => 
                        patient.name.toLowerCase().includes(searchTerm) ||
                        patient.tel.includes(searchTerm)
                    );
                }

                if (serviceFilter) {
                    filteredPatients = filteredPatients.filter(patient => {
                        if (patient.services && patient.services.length > 0) {
                            return patient.services.includes(serviceFilter);
                        }
                        return patient.service === serviceFilter;
                    });
                }

                if (statusFilter) {
                    filteredPatients = filteredPatients.filter(patient => 
                        patient.status === statusFilter
                    );
                }

                renderPatientsTable(filteredPatients);
            } catch (error) {
                console.error('Error filtering patients:', error);
                renderPatientsTable(patients);
            }
        }

        function filterPendingPatients() {
            try {
                const searchTerm = document.getElementById('pendingSearchInput').value.toLowerCase();
                const serviceFilter = document.getElementById('pendingServiceFilter').value;

                const pendingPatients = patients.filter(patient => {
                    const isPending = patient.status === 'registered';
                    const matchesSearch = patient.name.toLowerCase().includes(searchTerm) ||
                                        patient.tel.includes(searchTerm);
                    
                    let matchesService = true;
                    if (serviceFilter) {
                        if (patient.services && patient.services.length > 0) {
                            matchesService = patient.services.includes(serviceFilter);
                        } else {
                            matchesService = patient.service === serviceFilter;
                        }
                    }
                    
                    return isPending && matchesSearch && matchesService;
                });

                renderPendingPatients(pendingPatients);
            } catch (error) {
                console.error('Error filtering pending patients:', error);
            }
        }

        function renderPatientsTable(patientsToShow) {
            const tbody = document.getElementById('patientsTable');
            
            if (patientsToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                            <div class="empty-state-icon">üìã</div>
                            <div>No patients found matching your criteria</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = patientsToShow.map(patient => {
                const servicesDisplay = patient.services && patient.services.length > 0 
                    ? patient.services 
                    : (patient.service ? [patient.service] : []);
                
                return `
                <tr onclick="showPatientDetails(${JSON.stringify(patient).replace(/"/g, '&quot;')})" style="cursor: pointer;">
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 35px; height: 35px; border-radius: 50%; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; flex-shrink: 0;">
                                ${patient.name.charAt(0).toUpperCase()}
                            </div>
                            <div style="min-width: 0; flex: 1;">
                                <div style="font-weight: 600; color: var(--dark); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${patient.name}">${patient.name}</div>
                                <div style="font-size: 12px; color: #6b7280;">üìû ${patient.tel}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="font-weight: 500; color: var(--primary); font-size: 13px;" title="${servicesDisplay.join(', ')}">
                            ${servicesDisplay.length > 0 ? 
                                servicesDisplay.slice(0, 2).map(service => `<span class="service-tag" style="font-size: 10px; padding: 2px 4px; margin: 1px;">${service}</span>`).join('') +
                                (servicesDisplay.length > 2 ? `<div style="font-size: 10px; color: #6b7280;">+${servicesDisplay.length - 2} more</div>` : '')
                                : '<span style="color: #6b7280;">None</span>'
                            }
                        </div>
                    </td>
                    <td>
                        <div style="font-weight: 500; font-size: 13px;">${patient.familyGroup}</div>
                    </td>
                    <td>
                        <span class="status-badge ${patient.status === 'completed' ? 'status-completed' : 'status-registered'}">
                            ${patient.status === 'completed' ? 'COMPLETED' : 'PENDING'}
                        </span>
                    </td>
                    <td>
                        <div style="font-weight: 500; font-size: 12px;">${patient.registrationDate}</div>
                    </td>
                    <td onclick="event.stopPropagation();">
                        <div class="action-buttons">
                            ${patient.status === 'registered' ? `
                                <button class="btn btn-success btn-small" onclick="showCompletionForm(${JSON.stringify(patient).replace(/"/g, '&quot;')})" title="Complete medical record">
                                    ‚úèÔ∏è Complete
                                </button>
                            ` : ''}
                            <button class="btn btn-warning btn-small" onclick="showEditForm(${JSON.stringify(patient).replace(/"/g, '&quot;')})" title="Edit patient information">
                                üìù Edit
                            </button>
                            <button class="btn btn-danger btn-small" onclick="currentPatient = ${JSON.stringify(patient).replace(/"/g, '&quot;')}; confirmDeletePatient()" title="Delete patient">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </td>
                </tr>`}).join('');
        }

        function renderPendingPatients(pendingPatients) {
            const grid = document.getElementById('pendingPatientsGrid');
            
            if (pendingPatients.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéâ</div>
                        <h3>All Caught Up!</h3>
                        <p>No patients are currently pending tests. All registered patients have completed their medical records.</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = pendingPatients.map(patient => {
                const servicesDisplay = patient.services && patient.services.length > 0 
                    ? patient.services 
                    : (patient.service ? [patient.service] : []);
                
                return `
                <div class="patient-card" onclick="showCompletionForm(${JSON.stringify(patient).replace(/"/g, '&quot;')})">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2rem;">
                            ${patient.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div class="patient-name">${patient.name}</div>
                            <div style="color: var(--primary); font-weight: 600; margin-bottom: 8px;">
                                ${servicesDisplay.length > 0 ? 
                                    servicesDisplay.map(service => `<span class="service-tag" style="font-size: 10px; margin: 1px;">${service}</span>`).join('') : 
                                    '<span style="color: #6b7280;">No services</span>'
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="patient-info">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>üìû ${patient.tel}</div>
                            <div>üë• ${patient.familyGroup}</div>
                            <div>üéÇ ${patient.age} years</div>
                            <div>üë§ ${patient.sex}</div>
                        </div>
                        ${patient.occupation ? `<div style="margin-bottom: 10px;">üíº ${patient.occupation}</div>` : ''}
                    </div>
                    
                    <div class="patient-status">
                        <span class="status-badge status-registered">‚è≥ Pending Tests</span>
                        <div style="font-size: 0.85rem; color: #6b7280; margin-top: 8px;">
                            üìÖ Registered: ${patient.registrationDate} ${patient.registrationTime || ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Enhanced Reports Functions
        async function generateReport(type) {
            const reportResults = document.getElementById('reportResults');
            const reportContent = document.getElementById('reportContent');
            
            try {
                if (type === 'summary') {
                    generateSummaryReport(reportContent);
                } else if (type === 'detailed') {
                    generateDetailedReport(reportContent);
                }
                
                reportResults.classList.remove('hidden');
                reportResults.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                showAlert('dashboardAlert', '‚ùå Error generating report: ' + error.message, 'error');
            }
        }

        function generateSummaryReport(container) {
            const totalPatients = patients.length;
            const pendingTests = patients.filter(p => p.status === 'registered').length;
            const completedRecords = patients.filter(p => p.status === 'completed').length;
            const completionRate = totalPatients > 0 ? Math.round((completedRecords / totalPatients) * 100) : 0;

            // Enhanced service breakdown - handle both single and multiple services
            const serviceBreakdown = {};
            patients.forEach(patient => {
                const patientServices = patient.services && patient.services.length > 0 
                    ? patient.services 
                    : (patient.service ? [patient.service] : []);
                
                patientServices.forEach(service => {
                    serviceBreakdown[service] = (serviceBreakdown[service] || 0) + 1;
                });
            });

            // Family group breakdown
            const familyBreakdown = {};
            patients.forEach(patient => {
                familyBreakdown[patient.familyGroup] = (familyBreakdown[patient.familyGroup] || 0) + 1;
            });

            // Recent registrations (last 7 days)
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentRegistrations = patients.filter(patient => {
                const regDate = new Date(patient.registrationDate);
                return regDate >= sevenDaysAgo;
            }).length;

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="padding: 20px; background: var(--gradient-primary); color: white; border-radius: 16px; text-align: center;">
                        <h3 style="font-size: 2rem; margin-bottom: 5px;">${totalPatients}</h3>
                        <p>Total Patients</p>
                    </div>
                    <div style="padding: 20px; background: var(--gradient-success); color: white; border-radius: 16px; text-align: center;">
                        <h3 style="font-size: 2rem; margin-bottom: 5px;">${completionRate}%</h3>
                        <p>Completion Rate</p>
                    </div>
                    <div style="padding: 20px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border-radius: 16px; text-align: center;">
                        <h3 style="font-size: 2rem; margin-bottom: 5px;">${pendingTests}</h3>
                        <p>Pending Tests</p>
                    </div>
                    <div style="padding: 20px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border-radius: 16px; text-align: center;">
                        <h3 style="font-size: 2rem; margin-bottom: 5px;">${recentRegistrations}</h3>
                        <p>Recent (7 days)</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                    <div style="background: white; padding: 25px; border-radius: 16px; box-shadow: var(--shadow);">
                        <h4 style="color: var(--primary); font-weight: 700; margin-bottom: 15px;">üìä Service Distribution</h4>
                        ${Object.entries(serviceBreakdown).map(([service, count]) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span>${service}</span>
                                <span style="background: var(--primary); color: white; padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;">${count}</span>
                            </div>
                        `).join('') || '<div style="text-center; color: #6b7280; padding: 20px;">No services recorded</div>'}
                    </div>

                    <div style="background: white; padding: 25px; border-radius: 16px; box-shadow: var(--shadow);">
                        <h4 style="color: var(--success); font-weight: 700; margin-bottom: 15px;">üë• Family Group Distribution</h4>
                        ${Object.entries(familyBreakdown).map(([family, count]) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                <span>${family}</span>
                                <span style="background: var(--success); color: white; padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;">${count}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function generateDetailedReport(container) {
            const completedPatients = patients.filter(p => p.status === 'completed');
            const pendingPatients = patients.filter(p => p.status === 'registered');

            // Lab tests analysis
            const labTestsCount = {};
            completedPatients.forEach(patient => {
                if (patient.labTests && patient.labTests.length > 0) {
                    patient.labTests.forEach(test => {
                        labTestsCount[test] = (labTestsCount[test] || 0) + 1;
                    });
                }
            });

            container.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <h4 style="color: var(--primary); font-weight: 700; margin-bottom: 20px;">üìã Detailed Patient Report</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
                        <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h5 style="color: var(--success); font-weight: 600; margin-bottom: 15px;">‚úÖ Completed Patients (${completedPatients.length})</h5>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${completedPatients.map(patient => {
                                    const servicesDisplay = patient.services && patient.services.length > 0 
                                        ? patient.services.join(', ') 
                                        : (patient.service || 'No services');
                                    return `
                                    <div style="padding: 8px 0; border-bottom: 1px solid #e5e7eb; font-size: 14px;">
                                        <strong>${patient.name}</strong> - ${servicesDisplay}
                                        <div style="color: #6b7280; font-size: 12px;">Completed: ${patient.completionDate}</div>
                                    </div>
                                `;}).join('') || '<div style="color: #6b7280; text-align: center; padding: 20px;">No completed patients</div>'}
                            </div>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h5 style="color: var(--warning); font-weight: 600; margin-bottom: 15px;">‚è≥ Pending Patients (${pendingPatients.length})</h5>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${pendingPatients.map(patient => {
                                    const servicesDisplay = patient.services && patient.services.length > 0 
                                        ? patient.services.join(', ') 
                                        : (patient.service || 'No services');
                                    return `
                                    <div style="padding: 8px 0; border-bottom: 1px solid #e5e7eb; font-size: 14px;">
                                        <strong>${patient.name}</strong> - ${servicesDisplay}
                                        <div style="color: #6b7280; font-size: 12px;">Registered: ${patient.registrationDate}</div>
                                    </div>
                                `;}).join('') || '<div style="color: #6b7280; text-align: center; padding: 20px;">No pending patients</div>'}
                            </div>
                        </div>
                    </div>

                    ${Object.keys(labTestsCount).length > 0 ? `
                        <div style="background: white; padding: 25px; border-radius: 16px; box-shadow: var(--shadow);">
                            <h5 style="color: var(--info); font-weight: 600; margin-bottom: 15px;">üî¨ Lab Tests Analysis</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                ${Object.entries(labTestsCount).map(([test, count]) => `
                                    <div style="text-align: center; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 12px;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);">${count}</div>
                                        <div style="font-size: 14px; color: var(--dark);">${test}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function exportData() {
            try {
                const dataToExport = {
                    exportDate: new Date().toISOString(),
                    exportedBy: 'Health Campaign System v3.1.0 - Premium Multi-Service',
                    totalPatients: patients.length,
                    patients: patients.map(patient => ({
                        ...patient,
                        exportedAt: new Date().toISOString()
                    }))
                };

                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `health_campaign_data_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();

                showAlert('dashboardAlert', 'üìÅ Data exported successfully!', 'success');
            } catch (error) {
                showAlert('dashboardAlert', '‚ùå Export failed: ' + error.message, 'error');
            }
        }

        function closeReport() {
            document.getElementById('reportResults').classList.add('hidden');
        }

        function clearRegistrationForm() {
            document.getElementById('regName').value = '';
            document.getElementById('regAge').value = '';
            document.getElementById('regSex').value = '';
            document.getElementById('regOccupation').value = '';
            document.getElementById('regTel').value = '';
            document.getElementById('regFamilyGroup').value = '';
            
            // Clear all service checkboxes
            document.querySelectorAll('#servicesCheckboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
                updateServiceCheckboxStyle(checkbox);
            });
            
            // Hide validation message
            document.getElementById('servicesValidation').classList.add('hidden');
            
            clearAlert('registrationAlert');
        }

        function clearCompletionForm() {
            document.getElementById('compDiagnosis').value = '';
            document.getElementById('compTreatmentPlan').value = '';
            clearAlert('completionAlert');
            
            // Clear all checkboxes
            const checkboxes = document.querySelectorAll('#completionForm input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-info';
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            
            // Auto-clear success and info alerts
            if (type !== 'error') {
                setTimeout(() => {
                    clearAlert(containerId);
                }, 5000);
            }
        }

        function clearAlert(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '';
            }
        }

        // Close modals when clicking outside
        document.getElementById('patientModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePatientModal();
            }
        });

        document.getElementById('confirmationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeConfirmationModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePatientModal();
                closeConfirmationModal();
                closeReport();
            }
            
            // Quick navigation shortcuts
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        switchTab({target: document.querySelector('.nav-item')}, 'dashboard');
                        break;
                    case '2':
                        e.preventDefault();
                        switchTab({target: document.querySelectorAll('.nav-item')[1]}, 'pending');
                        break;
                    case '3':
                        e.preventDefault();
                        switchTab({target: document.querySelectorAll('.nav-item')[2]}, 'registration');
                        break;
                    case '4':
                        e.preventDefault();
                        switchTab({target: document.querySelectorAll('.nav-item')[3]}, 'reports');
                        break;
                }
            }
        });

        console.log('üè• Health Campaign Management System v3.1.0 - Premium Multi-Service Edition Loaded');
        console.log('‚ú® Features: Multi-service selection, Premium UI, Real-time updates, Professional design');
    </script>
</body>
</html>
